name: Login Tests CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-login:
    runs-on: ubuntu-latest
    
    # ⚠️ FIX: Set the default working directory to 'frontend'
    # Double-check that 'frontend' matches the exact case (e.g., 'frontend', not 'FrontEnd').
    defaults:
      run:
        working-directory: frontend

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Diagnostic Step: Verify directory structure
      - name: Show repository file structure
        # This will run from the root of the repo (before defaults.run takes effect)
        # and print out all files/folders to confirm the path and case of 'frontend'.
        run: ls -R
        working-directory: ${{ github.workspace }} # Run from repo root
        shell: bash

      # 3️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 4️⃣ Install dependencies (Runs in 'frontend' due to defaults.run)
      - name: Install Frontend dependencies
        # If the 'ls -R' output above shows a different case (e.g., 'FrontEnd'),
        # you must update the 'defaults.run.working-directory' setting above.
        run: npm install

      # 5️⃣ Run Unit Tests for Login
      - name: Run Login Unit Tests
        # Output file is created inside the 'frontend' folder
        run: |
          npm test -- --testPathPattern=Login --watchAll=false --json --outputFile=unit-test-result.json

      # 6️⃣ & 7️⃣ Run E2E Tests with Cypress (CRITICAL FIX: Starting the app)
      - name: Run Login E2E Tests
        # Using the dedicated Cypress action handles installation, waiting, and running reliably.
        uses: cypress-io/github-action@v6
        with:
          # CRITICAL: This starts your frontend app in the background.
          start: npm start
          # CRITICAL: This waits for the app to be available before Cypress runs tests. 
          wait-on: 'http://localhost:3000'
          # Use the path relative to the root of the project
          spec: 'cypress/e2e/login.e2e.spec.js'
          # We explicitly set the working directory for this action as a safeguard
          working-directory: frontend 

      # 8️⃣ Upload test reports as artifacts
      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: login-test-reports
          path: |
            # Corrected path for unit test result
            frontend/unit-test-result.json
            # Assuming the E2E XML file is created relative to the working directory
            frontend/cypress/results/e2e-results.xml
          retention-days: 7
